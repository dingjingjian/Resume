<!DOCTYPE html>
<html lang="zh">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>用户管理</title>

	<!-- 引入样式表 -->
	<!-- layui.css为layui框架样式 -->
	<link rel="stylesheet" href="./assets/layui/css/layui.css">
	<!-- theme.css为主题颜色样式 -->
	<link rel="stylesheet" href="./static/css/theme.css">
	<!-- common.css为公共样式 -->
	<link rel="stylesheet" href="./static/css/common.css">

</head>

<body>
	<div class="layui-fluid">
		<!-- 面包屑导航 -->
		<div class="layui-card main-breadcrumb">
			<!-- 面包屑导航  通过'lay-separator'属性设置分隔符号  a标签的href可以写对应的跳转地址-->
			<span class="layui-breadcrumb" lay-separator=">">
				<a href="#"><i class="layui-icon layui-icon-home"></i> 首页</a>
				<a href="#">维护与管理</a>
				<a><cite>用户管理</cite></a>
			</span>
		</div>
		<div class="layui-card">
			<div class="layui-card-header">
				<h1>用户管理</h1>
			</div>
			<div class="layui-card-body">
				<table id="mmSubsystemTable" lay-filter="table">
				</table>
			</div>
		</div>
	</div>
	<!-- JS引入 -->
	<!-- layui.js为框架必需js -->
	<script src="./assets/layui/layui.js"></script>
	<!-- jquery.min.js layui依赖JQ -->
	<script src="./assets/jquery.min.js"></script>
	<!-- common.js 公共js -->
	<script src="./static/js/common.js"></script>

	<!-- 维护管理子系统.js -->
	<script>
		//实际项目时，可将以下代码存入页面对应js文件
		layui.use(['element', 'form', 'table'], function () {
			//引入框架所需组件 基础组件、表单组件、表格组件
			var element = layui.element
				, form = layui.form
				, table = layui.table;
			element.render();
			form.render();
			//模拟数据实际项目删除
			var testData = [
				{
					'name':'姓名',
					'gender':'M',
					'username':'用户',
					'password':'123456',
					'phonenum':'13545141414',
					'department':'部门',
					'description':'描述',
					'role':'角色'
				},
				{
					'name':'姓名',
					'gender':'M',
					'username':'用户',
					'password':'123456',
					'phonenum':'13545141414',
					'department':'部门',
					'description':'描述',
					'role':'角色'
				},
				{
					'name':'姓名',
					'gender':'M',
					'username':'用户',
					'password':'123456',
					'phonenum':'13545141414',
					'department':'部门',
					'description':'描述',
					'role':'角色'
				},
				{
					'name':'姓名',
					'gender':'M',
					'username':'用户',
					'password':'123456',
					'phonenum':'13545141414',
					'department':'部门',
					'description':'描述',
					'role':'角色'
				},
				{
					'name':'姓名',
					'gender':'M',
					'username':'用户',
					'password':'123456',
					'phonenum':'13545141414',
					'department':'部门',
					'description':'描述',
					'role':'角色'
				},
				{
					'name':'姓名',
					'gender':'M',
					'username':'用户',
					'password':'123456',
					'phonenum':'13545141414',
					'department':'部门',
					'description':'描述',
					'role':'角色'
				},
				{
					'name':'姓名',
					'gender':'M',
					'username':'用户',
					'password':'123456',
					'phonenum':'13545141414',
					'department':'部门',
					'description':'描述',
					'role':'角色'
				},
				{
					'name':'姓名',
					'gender':'M',
					'username':'用户',
					'password':'123456',
					'phonenum':'13545141414',
					'department':'部门',
					'description':'描述',
					'role':'角色'
				},
				{
					'name':'姓名',
					'gender':'M',
					'username':'用户',
					'password':'123456',
					'phonenum':'13545141414',
					'department':'部门',
					'description':'描述',
					'role':'角色'
				},
				{
					'name':'姓名',
					'gender':'M',
					'username':'用户',
					'password':'123456',
					'phonenum':'13545141414',
					'department':'部门',
					'description':'描述',
					'role':'角色'
				},
				{
					'name':'姓名',
					'gender':'M',
					'username':'用户',
					'password':'123456',
					'phonenum':'13545141414',
					'department':'部门',
					'description':'描述',
					'role':'角色'
				},
				{
					'name':'姓名',
					'gender':'M',
					'username':'用户',
					'password':'123456',
					'phonenum':'13545141414',
					'department':'部门',
					'description':'描述',
					'role':'角色'
				}
			]

			//表头参数设置 field 设定字段名，title 设置表头名称，通过width,minWidth,maxWidth可设置列宽，fixed: 'left'/'right'设置列的左右固定
			var cols = [[
				{ type: 'checkbox', fixed: 'left' }
				, {type:'numbers', title: '编号'}
				, { field: 'name', title: '姓名', minWidth: 80 }
				//数据判断，如果不需要，可以将templet:{}去掉杰克。d可以取到当前行的数据
				, { field: 'gender', title: '性别', width: 80, templet: function(d){
						return d.gender=='M'?'男':'女'
					}
				}
				, { field: 'username', title: '用户名', minWidth: 80 }
				, { field: 'password', title: '密码', minWidth: 80 }
				, { field: 'phonenum', title: '手机号', minWidth: 177 }
				, { field: 'department', title: '部门', minWidth: 80 }
				, { field: 'description', title: '描述', minWidth: 80 }
				, { field: 'role', title: '角色', maxWidth: 180 }
				, { title: '操作', width: 180, fixed: 'right', templet: function(d){
						return '<a class="layui-btn layui-btn-xs" lay-event="edit" href="javascript:;"><i class="layui-icon">&#xe642;</i>编辑</a><a class="layui-btn layui-btn-xs layui-btn-danger" style="background:#FF5722;" lay-event="del" href="javascript:;"><i class="layui-icon">&#xe640;</i>删除</a>'
					}
				}
			]]
			// 列表配置
			window.tableList = table.render({
				elem: '#mmSubsystemTable' //指向存放分页的容器
				, cols:  cols //表头
				, page: true //是否显示分页
				, toolbar: '<div><button type="button" class="layui-btn layui-btn-sm" lay-event="adds">新增用户</button><button type="button" class="layui-btn layui-btn-sm layui-btn-danger" lay-event="dels">批量删除</button></div>'
				, limit: 10 //每页默认显示的数量
				, limits: [10, 20, 50, 100] //每页条数的选择项
				, defaultToolbar: ['filter'] //自定义头部工具栏右侧图标。如无需自定义，去除该参数即可
				, data: testData //加载测试数据实际项目删除
				// AJAX请求下的配置分页
				// ,url:'${pageContext.request.contextPath}/user/selectAllUsers' //列表数据接口地址
				// ,method:'GET'//请求方式
				// ,request: {
				// 	pageName: 'pn' //页码的参数名称，默认：page
				// 	,limitName: 'pageSize' //每页数据量的参数名，默认：limit
				// }
				// ,parseData: function(res){ //res 即为原始返回的数据
				// 	return {
				// 		"code": res.code, //解析接口状态
				// 		"msg": res.msg, //解析提示文本
				// 		"count": res.data.count, //解析数据长度
				// 		"data": res.data.list //解析数据列表
				// 	};
				// }
			});
			
			//监听头工具栏事件
			//  obj 对象，包含event元素 和 table 配置
			table.on('toolbar(table)', function (obj) {
				var checkStatus = table.checkStatus(obj.config.id);
				var arr = []
				$.each(checkStatus.data, function (index, value) {
					arr.push(value.id)
				})
				switch (obj.event) {
					case 'adds': // 新增用户
						addOrUpdate(null, 'add');
						break;
					case 'dels': // 批量删除
						if (arr.length === 0) {
							layer.msg('请先勾选数据'); //提示框
						} else {
							layer.confirm('确认要删除这些数据吗？', {
								title: '提示'
							}, function (index) {
								$.ajax({
									url:"${pageContext.request.contextPath}/user/deleteUser/"+arr.join('-'),
									type:"DELETE",
									success:function(result){            
										layer.msg('批量删除成功', { time: 1000 }); //提示框
										tableList.reload(); // 表格重载
									},
									error: function (xhr) {
										layer.close(llo);
										layer.msg('系统错误，请联系管理员');
									}
								});
								layer.close(index);
							});
						}
					break;
				};
			});
			//监听行工具事件
			table.on('tool(table)', function (obj) {
				//obj.data 可获取当前行的数据
				var data = obj.data;
				if (obj.event === 'edit') { // 修改当前行数据
					addOrUpdate(data, 'update')
				} else if (obj.event === 'del') { // 删除单条行数据
					layer.confirm('确认要删除该条数据吗？', { title: '提示' }, function (index) {
						$.ajax({
							url:"${pageContext.request.contextPath}/user/deleteUser/"+data.id,
							type:"DELETE",
							success:function(result){            
								layer.msg('删除成功', { time: 1000 }); //提示框
								tableList.reload(); // 表格重载
							},
							error: function (xhr) {
								layer.close(llo);
								layer.msg('系统错误，请联系管理员');
							}
						});
						layer.close(index);
					});
				}
			});
			//添加或修改
			function addOrUpdate(data, addOrUpdate) {
				var title = '新增';
				var formId = '';
				if (addOrUpdate == 'update') {
					title = '修改';
					if (data) formId = data.id;
				}
				layer.open({
					type: 1,//弹窗类型
					resize: false,//弹窗是否允许拉伸
					title: title + '用户',//标题设置
					area: ['480px'],//弹窗大小设置
					content: '<form class="layui-form" style="padding:20px;" lay-filter="layer">'
						// + '<div class="layui-form-item">'
						// + '<label class="layui-form-label">ID</label>'
						// + '<div class="layui-input-block">'
						// + '<input type="text" id="ID" name="ID" placeholder="请输入ID" autocomplete="off" class="layui-input" lay-verify="required">'
						// + '</div>'
						// + '</div>'
						+ '<div class="layui-form-item">'
						+ '<label class="layui-form-label">姓名</label>'
						+ '<div class="layui-input-block">'
						+ '<input type="text" id="NAME" name="NAME" placeholder="请输入姓名" autocomplete="off" class="layui-input" lay-verify="required">'
						+ '</div>'
						+ '</div>'
						+ '<div class="layui-form-item">'
						+ '<label class="layui-form-label">性别</label>'
						+ '<div class="layui-input-block">'
						+ '<input type="radio" name="GENDER" value="M" title="男" checked>'
						+ '<input type="radio" name="GENDER" value="F" title="女">'
						+ '</div>'
						+ '</div>'
						+ '<div class="layui-form-item">'
						+ '<label class="layui-form-label">用户名</label>'
						+ '<div class="layui-input-block">'
						+ '<input type="text" id="USERNAME" name="USERNAME" placeholder="请输入用户名" autocomplete="off" class="layui-input" lay-verify="required">'
						+ '</div>'
						+ '</div>'
						+ '<div class="layui-form-item">'
						+ '<label class="layui-form-label">密码</label>'
						+ '<div class="layui-input-block">'
						+ '<input type="text" id="PASSWORD" name="PASSWORD" placeholder="请输入密码" autocomplete="new-password" class="layui-input" lay-verify="required">'
						+ '</div>'
						+ '</div>'
						+ '<div class="layui-form-item">'
						+ '<label class="layui-form-label">手机号</label>'
						+ '<div class="layui-input-block">'
						+ '<input type="text" id="PHONENUM" name="PHONENUM" placeholder="请输入手机号" autocomplete="off" class="layui-input" lay-verify="phone">'
						+ '</div>'
						+ '</div>'
						+ '<div class="layui-form-item">'
						+ '<label class="layui-form-label">部门</label>'
						+ '<div class="layui-input-block">'
						+ '<input type="text" id="DEPARTMENT" name="DEPARTMENT" placeholder="请输入部门" autocomplete="off" class="layui-input" lay-verify="required">'
						+ '</div>'
						+ '</div>'
						+ '<div class="layui-form-item">'
						+ '<label class="layui-form-label">描述</label>'
						+ '<div class="layui-input-block">'
						+ '<input type="text" id="DESCRIPTION" name="DESCRIPTION" placeholder="请输入描述" autocomplete="off" class="layui-input" lay-verify="required">'
						+ '</div>'
						+ '</div>'
						+ '<div class="layui-form-item">'
						+ '<label class="layui-form-label">角色</label>'
						+ '<div class="layui-input-block">'
						+ '<select id="ROLE" name="ROLE" lay-verify="required">'
						+ '<option value="">请选择角色</option>'
						+ '</select>'
						+ '</div>'
						+ '</div>'
						+ '<div class="layui-form-item">'
						+ '<div class="layui-input-block">'
						+ '<button class="layui-btn" lay-submit lay-filter="submit">提交</button>'
						+ '<button type="button" class="layui-btn layui-btn-primary colse-btn">关闭</button>'
						+ '</div>'
						+ '</div>'
						+ '</form>',
					success: function (layero, index) {//成功弹窗回调
						//关闭弹窗
						$('.colse-btn').click(function () {
							layer.close(index); 
						})
						//加载角色列表
						$.ajax({
							url:"${pageContext.request.contextPath}/user/selectAllRoles",
							type:"GET",
							success:function(result){            
								//显示部门信息在下拉列表中
								var optionStr = ''
								$.each(result,function(){
									optionStr += '<option value="'+this.role+'">'+this.role+'</option>';
								});
								$('#ROLE').append(optionStr);
								//选择组件渲染
								form.render('select', 'layer');
							}
						});
						//弹窗如果为新增
						if (addOrUpdate == 'update') {
							//载入数据
							form.val("layer", { //layer 即 class="layui-form" 所在元素属性 lay-filter="" 对应的值
								// "ID": data.id, // "name": "value"
								"NAME": data.name
								,"GENDER": data.gender
								,"USERNAME": data.username
								,"PASSWORD": data.password
								,"PHONENUM": data.phonenum
								,"DEPARTMENT": data.department
								,"DESCRIPTION": data.description
								,"ROLE": data.role
							});
						}else{
							//设置增加用户模态窗初始id值为当前用户的最后id
							// $.ajax({
							// 	url:"${pageContext.request.contextPath}/user/selectAllUsers",
							// 	type:"GET",
							// 	dataType:"json",
							// 	success:function(result){
							// 		id=result.total+1;
							// 		form.val("layer", { //layer 即 class="layui-form" 所在元素属性 lay-filter="" 对应的值
							// 			"ID": id // "name": "value"
							// 		});
							// 	}
							// });
						}
						//表单组件渲染
						form.render(null, 'layer');
						var USERNAME = true;
						//ajax校验用户名是否可用
						$("#USERNAME").change(function(){
							//发送ajax请求校验用户名是否可用
							var UserName = this.value;
							// $.ajax({
							// 	url:"${pageContext.request.contextPath}/user/checkUser",
							// 	data:"UserName="+UserName,
							// 	type:"POST",
							// 	dataType: "text",
							// 	success:function(result){
							// 		if(result=="illegal"){
							// 			layer.msg('用户名为2-5位中文或者6-16位英文和数字的组合', {icon: 5,anim: 6});
							// 			$('#USERNAME').addClass('layui-form-danger');
							// 			USERNAME = false;
							// 		}else if(result=="duplicate"){
							// 			layer.msg('用户名已存在', {icon: 5,anim: 6});
							// 			$('#USERNAME').addClass('layui-form-danger');
							// 			USERNAME = false;
							// 		}else{
							// 			layer.msg('用户名可用', {icon: 6});
							// 			$('#USERNAME').removeClass('layui-form-danger');
							// 			USERNAME = true;
							// 		}   
							// 	}
							// });
							// 姓名验证方法示例
							$('#USERNAME').removeClass('input-green').closest('.layui-form-item').find('.form-tips').remove();
							if(UserName=="illegal"){
								layer.msg('用户名为2-5位中文或者6-16位英文和数字的组合',{'time':800});//不需要悬浮提醒 可以删去
								$('#USERNAME').addClass('layui-form-danger').focus().parent().after('<div class="form-tips warnning">用户名为2-5位中文或者6-16位英文和数字的组合</div>');
								USERNAME = false;
							}else if(UserName=="duplicate"){
								layer.msg('用户名已存在',{'time':800});
								$('#USERNAME').addClass('layui-form-danger').focus().parent().after('<div class="form-tips warnning">用户名已存在</div>');
								USERNAME = false;
							}else{
								layer.msg('用户名可用',{'time':800});
								$('#USERNAME').removeClass('layui-form-danger').addClass('input-green');
								USERNAME = true;
							}
							//重新调整弹窗大小
							layer.style(index, {
								height: $('[lay-filter="layer"]').height()+80
							});
						});
						//ajax手机号是否可用
						var PHONENUM = true;
						$("#PHONENUM").change(function(){
							var phoneNumber=this.value;
							// $.ajax({
							// 	url:"${pageContext.request.contextPath}/user/checkPhone",
							// 	data:"PhoneNumber="+phoneNumber,
							// 	type:"POST",
							// 	dataType: "text",
							// 	success:function(result){
							// 		switch(result){
							// 		case "lengthErr":
							// 			layer.msg('请输入十一位手机号', {icon: 5,anim: 6});
							// 			$('#PHONENUM').addClass('layui-form-danger');
							// 			PHONENUM = false;
							// 			break;
							// 		case "numberErr":
							// 			layer.msg('请输入正确的手机号', {icon: 5,anim: 6});
							// 			$('#PHONENUM').addClass('layui-form-danger');
							// 			PHONENUM = false;
							// 			break;
							// 		case "duplicate":
							// 			layer.msg('该手机号已注册', {icon: 5,anim: 6});
							// 			$('#PHONENUM').addClass('layui-form-danger');
							// 			PHONENUM = false;
							// 			break;
							// 		case "success":
							// 			layer.msg('号码可用', {icon: 6});
							// 			$('#PHONENUM').removeClass('layui-form-danger');
							// 			PHONENUM = true;
							// 			break;
							// 		}                     
							// 	}
							// });
							// 手机验证方法示例
							$('#PHONENUM').removeClass('input-green').closest('.layui-form-item').find('.form-tips').remove();
							if(phoneNumber=="lengthErr"){
								layer.msg('请输入十一位手机号',{'time':800});
								$('#PHONENUM').addClass('layui-form-danger').focus().parent().after('<div class="form-tips warnning">请输入十一位手机号</div>');
								PHONENUM = false;
							}else if(phoneNumber=="numberErr"){
								layer.msg('请输入正确的手机号',{'time':800});
								$('#PHONENUM').addClass('layui-form-danger').focus().parent().after('<div class="form-tips warnning">请输入正确的手机号</div>');
								PHONENUM = false;
							}else if(phoneNumber=="duplicate"){
								layer.msg('该手机号已注册',{'time':800});
								$('#PHONENUM').addClass('layui-form-danger').focus().parent().after('<div class="form-tips warnning">该手机号已注册</div>');
								PHONENUM = false;
							}else{
								layer.msg('号码可用',{'time':800});
								$('#PHONENUM').removeClass('layui-form-danger').addClass('input-green');
								PHONENUM = true;
							}
							//重新调整弹窗大小
							layer.style(index, {
								height: $('[lay-filter="layer"]').height()+80
							});
						});
						//表单提交回调
						form.on('submit(submit)', function (data) {
							if(USERNAME&&PHONENUM){
								//如果为新增
								if (addOrUpdate == 'add') {
									var ajaxUrl = "${pageContext.request.contextPath}/user/addUser"
								}else{
									var ajaxUrl = "${pageContext.request.contextPath}/user/updateUser/" + formId
								}
								var llo = layer.load(2, { shade: [0.001, '#fff'] });
								$.ajax({
									url:ajaxUrl,
									cache: false,
									type: "POST",
									dataType: "json",
									data: data.field,
									success: function (data) {
										layer.close(llo);
										layer.msg('操作成功', { time: 1000 });
										tableList.reload(); //只重载数据
										layer.close(index);
									},
									error: function (xhr) {
										layer.close(llo);
										layer.msg('系统错误，请联系管理员');
									}
								});
							}
							return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
						});
					}
				});
			}
		});
	</script>
</body>

</html>